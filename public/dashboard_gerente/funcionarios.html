<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funcion√°rios</title>
    <script src="https://jsuites.net/v5/jsuites.js"></script>
    <script src="https://jsuites.net/v5/jsuites.webcomponents.js"></script>
    <link rel="stylesheet" href="https://jsuites.net/v5/jsuites.css" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/gerente.css">
    <script src="../js/sessao.js"></script>
</head>

<body>
    <nav class="sidebar">
        <div class="side_container">
            <div class="side_titulo">
                <span>AllSet</span>
            </div>
            <div class="side_perfil">
                <div class="foto_perfil">
                    <img src="https://www.elhombre.com.br/wp-content/uploads/2023/06/jon-hamm-1494357063.jpg" alt="">
                </div>
                <span class="boas_vindas_span">Bem-vindo de volta, <br> <span class="nome_usuario" id="b_usuario">Marcos</span></span>
            </div>
            <div class="side_topicos">
                <ul class="side_menu">
                    <li onclick="irParaDash()"><i>üìä</i> Dashboard</li>
                    <li class="section_active"><i>üíª</i> Funcion√°rios</li>
                    <li onclick="irParaAlertas()"><i>üîî</i> Alertas</li>
                    <div class="dividir_side"></div>
                    <li><i>‚ùì</i> Ajuda</li>
                    <li><i>üö™</i> Sair</li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main_content">
        <div class="nav_main">
            <div class="titulo_main">
                <div class="inicio_titulo">
                    Funcion√°rios
                </div>
            </div>
            <div class="exibir_data">
                <div class="alerta_data_hora">
                    <span>üìÖ 29/03/2025</span>
                </div>
            </div>
        </div>
        <div class="alertas_section">
            <div class="top_alerta">
                <div class="titulo_alerta">Usu√°rios Cadastrados</div>
                <div class="ver_alertas" onclick="document.querySelector('jsuites-modal').modal.open()" class='plain'>
                    Cadastrar Novo Funcion√°rio <span>‚Üí</span>
                </div>
            </div>

            <jsuites-modal title="Cadastrar novo Funcion√°rio" closed="true" width="900" height="480">
                <div class="funcionario_container">
                    <div class="campos_cadastro_func">
                        <div class="topo">
                            <div class="nome_campo">
                                <span>Nome</span>
                                <input type="text" id="nome_input">
                            </div>
                            <div class="cpf_campo">
                                <span>CPF</span>
                                <input type="text" id="cpf_input">
                            </div>
                            <div class="cargo_campo">
                                <span>Cargo</span>
                                <input type="text" id="cargo_input">
                            </div>
                        </div>
                        <div class="meio">
                            <div class="email_campo">
                                <span>Email</span>
                                <input type="text" id="email_input">
                            </div>
                        </div>
                        <div class="fim">
                            <div class="senha_campo">
                                <span>Senha</span>
                                <input type="password" id="senha_input">
                            </div>
                            <div class="confirmar_senha_campo">
                                <span>Confirmar Senha</span>
                                <input type="password" id="senha_confirmacao_input">
                            </div>
                        </div>
                    </div>
                    <div class="botao_cadastrar">
                        <button onclick="cadastrarFuncionario()">Cadastrar</button>
                    </div>
                </div>
            </jsuites-modal>

            <table class="tabela_alertas carros_tabela">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Cargo</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Tabela ser√° preenchida dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function cadastrarFuncionario() {
            const idAgencia = sessionStorage.getItem("fk_agencia");
            const nome = document.getElementById("nome_input").value;
            const cpf = document.getElementById("cpf_input").value;
            const email = document.getElementById("email_input").value;
            const senha = document.getElementById("senha_input").value;
            const nivel_permissao = document.getElementById("cargo_input").value;

            try {
                const response = await fetch("/usuarios/cadastrar2", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nome, cpf, email, senha, nivel_permissao, fk_agencia: idAgencia })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text);
                }

                const data = await response.json();
                console.log("Usu√°rio cadastrado:", data);
                alert("Cadastro conclu√≠do com sucesso!");
                window.location.href = "funcionarios.html";
            } catch (error) {
                console.error("Erro ao cadastrar funcion√°rio:", error.message);
                alert("Erro ao cadastrar: " + error.message);
            }
        }

        function irParaDash() {
            window.location.href = "gerente.html";
        }

        function irParaAlertas() {
            window.location.href = "alertaGerente.html";
        }

        async function carregarFuncionarios() {
            const idAgencia = sessionStorage.getItem("fk_agencia");

            try {
                const response = await fetch(`/usuarios/selecionarFuncionarioDaEmpresa/${idAgencia}`);
                if (!response.ok) throw new Error(await response.text());

                const funcionarios = await response.json();
                const tbody = document.querySelector(".tabela_alertas tbody");
                tbody.innerHTML = "";

                funcionarios.forEach(func => {
                    const tr = document.createElement("tr");

                    const tdNome = document.createElement("td");
                    tdNome.textContent = func.nome;

                    const tdEmail = document.createElement("td");
                    tdEmail.textContent = func.email;

                    const tdCargo = document.createElement("td");
                    tdCargo.textContent = func.nivel_permissao;

                    const tdStatus = document.createElement("td");
                    tdStatus.textContent = func.ativo === 1 ? "Ativo" :
                                           func.ativo === 0 ? "Inativo" : "Pendente";

                    if (func.ativo === 0) {
                        tdStatus.classList.add("alerta_crit");
                    } else if (func.ativo !== 1) {
                        tdStatus.classList.add("alerta_pend");
                    }

                    tr.appendChild(tdNome);
                    tr.appendChild(tdEmail);
                    tr.appendChild(tdCargo);
                    tr.appendChild(tdStatus);

                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Erro ao carregar funcion√°rios:", error.message);
            }
        }

        window.onload = () => {
            carregarFuncionarios();
        };
    </script>
</body>

</html>
