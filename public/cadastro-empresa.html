<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/login.css">
    <link rel="stylesheet" href="./css/cadastro-func.css">
    <link rel="stylesheet" href="./css/mobile-login.css">
    <link rel="stylesheet" href="./css/scroll.css">
    <link rel="website icon" type="png" href="./assets/img/logoAllSet.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <script src="https://kit.fontawesome.com/88fed8b646.js" crossorigin="anonymous"></script>
    <title>AllSet - Cadastro Empresa</title>
</head>

<body>

    <a onclick="voltarCadastro()" class="voltar">
        <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1 class="titulo-form">AllSet</h1>

    <div class="formulario">
        <span class="titulo">Cadastro - Empresa</span>

        <!-- Cadastro Empresa -->
        <div id="cadastro1">
            <div class="campo">
                <span>Nome da Empresa:</span>
                <input id="nomeEmpresa_input" type="text" placeholder="AllSet Monitoramento">
            </div>
            <div class="campo">
                <span>CNPJ:</span>
                <small>Digite apenas números</small>
                <input id="cnpj_input" type="text" placeholder="00000000000000">
            </div>
        </div>


        <!-- Cadastro Unidade -->
        <div id="cadastro2">
            <div class="campo">
                <span>CEP:</span>
                <input id="cep_input" type="text" placeholder="00000-000">
            </div>
            <div class="campo">
                <span>Número:</span>
                <input id="numero_input" type="text" placeholder="111">
            </div>
            <div class="campo">
                <span>Complemento:</span>
                <input id="complemento_input" type="text" placeholder="Apt./Casa/Bloco">
            </div>
        </div>

        
        <!-- Cadastro Endereco -->
        <div id="cadastro2">
            <div class="campo">
                <span>Logradouro: </span>
                <input id="logradouro_input" type="text" placeholder="Avenida Paulista">
            </div>
            <div class="campo">
                <span>Bairro: </span>
                <input id="bairro_input" type="text" placeholder="Bairro Exemplo">
            </div>
            <div class="campo">
                <span>Cidade: </span>
                <input id="cidade_input" type="text" placeholder="São Paulo">
            </div>
            <div class="campo">
                <span>UF: </span>
                <input id="uf_input" type="text" placeholder="SP/RJ">
            </div>
            <div class="campo">
                <span>Estado: </span>
                <input id="estado_input" type="text" placeholder="São Paulo">
            </div>
        </div>

        <!-- Cadastro Usuário -->
        <div id="cadastro3">
            <div class="campo">
                <span>Nome:</span>
                <input id="username_input" type="text" placeholder="Usuário administrativo">
            </div>
            <div class="campo">
                <span>Email:</span>
                <input id="email_input" type="email" placeholder="email@email.com">
            </div>
            <div class="cpf">
                <span>CPF:</span>
                <input id="cpf_input" type="text" placeholder="000.000.000-00">
            </div>
            <div class="campo">
                <span>Senha:</span>
                <input id="password_input" type="password" placeholder="********">
            </div>
        </div>

        <button id="btn_cadastro" class="botao" onclick="cadastrarEmpresa()">Cadastrar</button>
    </div>

    <div id="div_aguardar" class="loading-div">
        <img src="./assets/gifazul.gif" id="loading-gif">
    </div>

</body>

<script>
    async function cadastrarEmpresa() {
        try {
            const nomeEmpresa = document.getElementById("nomeEmpresa_input").value;
            const cnpj = document.getElementById("cnpj_input").value;

            const response = await fetch("/empresas/cadastrar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nome: nomeEmpresa, cnpj: cnpj })
            });

            const data = await response.json();
            console.log("Resposta da empresa:", data);

            if (!data.insertId) throw new Error("ID da empresa não retornado!");

            sessionStorage.setItem("id_empresa", data.insertId);
            console.log("ID da empresa salvo:", sessionStorage.getItem("id_empresa"));

            await cadastrarAgencia();
        } catch (error) {
            console.error("Erro ao cadastrar empresa:", error);
        }
    }

    async function cadastrarAgencia() {
        try {
            const idEmpresa = sessionStorage.getItem("id_empresa");
            if (!idEmpresa) throw new Error("ID da empresa não encontrado!");

            const cep = document.getElementById("cep_input").value;
            const numero = document.getElementById("numero_input").value;
            const complemento = document.getElementById("complemento_input").value;

            const response = await fetch("/unidades/cadastrar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cep, numero, complemento, fk_empresa: idEmpresa })
            });

            const data = await response.json();
            console.log("Resposta da agência:", data);

            if (!data.insertId) throw new Error("ID da agência não retornado!");

            sessionStorage.setItem("id_agencia", data.insertId);
            console.log("ID da agência salvo:", sessionStorage.getItem("id_agencia"));

            await cadastrarEndereco();
        } catch (error) {
            console.error("Erro ao cadastrar agência:", error);
        }
    }

    async function cadastrarEndereco() {
        try {
            const idAgencia = sessionStorage.getItem("id_agencia");
            if (!idAgencia) throw new Error("ID da agência não encontrado!");

            const logradouro = document.getElementById("logradouro_input").value;
            const bairro = document.getElementById("bairro_input").value;
            const cidade = document.getElementById("cidade_input").value;
            const uf = document.getElementById("uf_input").value.toUpperCase();
            const estado = document.getElementById("estado_input").value;

            const response = await fetch("/enderecos/cadastrar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ logradouro, bairro, cidade, uf, estado, fk_agencia_endereco: idAgencia })
            });

            const data = await response.json();
            console.log("Resposta do Endereço:", data);

            if (!data.insertId) throw new Error("ID da endereço não retornado!");

            console.log("ID da agência salvo:", sessionStorage.getItem("id_agencia"));

            await cadastrarUsuario();
        } catch (error) {
            console.error("Erro ao cadastrar endereço:", error);
        }
    }

    async function cadastrarUsuario() {
        try {
            const idAgencia = sessionStorage.getItem("id_agencia");
            if (!idAgencia) throw new Error("ID da agência não encontrado!");

            const nome = document.getElementById("username_input").value;
            const cpf = document.getElementById("cpf_input").value;
            const email = document.getElementById("email_input").value;
            const senha = document.getElementById("password_input").value;

            const response = await fetch("/usuarios/cadastrar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nome, cpf, email, senha, fk_agencia: idAgencia })
            });

            const data = await response.json();
            console.log("Usuário cadastrado com sucesso!", data);

            alert("Cadastro concluído com sucesso!");
            window.location.href = "login.html";
        } catch (error) {
            console.error("Erro ao cadastrar usuário:", error);
        }
    }
</script>

</html>